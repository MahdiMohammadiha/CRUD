<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>Dynamic CRUD UI</title>
    <style>
        /* Basic page styling */
        body {
            font-family: Tahoma, sans-serif;
            padding: 20px;
            direction: rtl;
            /* Right-to-left text */
        }

        /* Buttons styling */
        button {
            margin: 0 5px 10px 5px;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            background-color: #275e98;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #142a43;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Table styling */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: center;
        }

        th {
            background: #ddd;
            font-weight: bold;
            cursor: pointer;
            /* Indicate sortable columns */
        }

        tr:nth-child(odd) {
            background: #f9f9f9;
            /* Alternating row color */
        }

        tr:nth-child(even) {
            background: #fff;
        }

        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
        }

        #tables-bar {
            margin-bottom: 20px;
            /* Space below navbar */
        }

        .btn-primary {
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- Tables Navbar -->
    <h2>Tables</h2>
    <div id="tables-bar"></div> <!-- Buttons to select each table -->
    <div id="table-container"></div> <!-- Container where table data is rendered -->

    <script>
        // Base API URL
        const API_BASE_URL = "http://127.0.0.1:8000";

        // Global state variables
        let tables = [];           // List of tables from server
        let schema = [];           // Current table schema
        let data = [];             // Current table rows
        let editingRowIndex = null; // null = no edit, -1 = add new
        let formData = {};         // Temporary form data for add/edit
        let sortState = {          // Track sorting column & order
            columnIndex: null,
            ascending: true
        };

        // Helper: fetch JSON with error handling
        async function fetchJSON(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        }

        // Load all table names and create navbar buttons
        async function loadTables() {
            try {
                tables = await fetchJSON(API_BASE_URL + "/api/tables");
                const bar = document.getElementById("tables-bar");
                bar.innerHTML = "";
                tables.forEach(tbl => {
                    const btn = document.createElement("button");
                    btn.textContent = tbl.table;
                    btn.onclick = () => loadTableData(tbl.table); // Load table on click
                    bar.appendChild(btn);
                });
            } catch (e) {
                alert("Failed to load tables");
            }
        }

        // Load schema and rows for a specific table
        async function loadTableData(tableName) {
            try {
                schema = await fetchJSON(`${API_BASE_URL}/api/tables/${tableName}/schema`);
                data = await fetchJSON(`${API_BASE_URL}/api/tables/${tableName}`);

                // Reset state variables
                editingRowIndex = null;
                formData = {};
                sortState = { columnIndex: null, ascending: true };

                renderTable(tableName);
            } catch (e) {
                alert("Failed to load table data");
            }
        }

        // Render table and optional add/edit form
        function renderTable(tableName) {
            const container = document.getElementById("table-container");
            container.innerHTML = "";

            // Table title
            const title = document.createElement("h3");
            title.textContent = `Table: ${tableName}`;
            container.appendChild(title);

            // Add Record button
            const addBtn = document.createElement("button");
            addBtn.textContent = "Add Record";
            addBtn.onclick = () => {
                editingRowIndex = -1; // Add mode
                formData = {};
                renderTable(tableName);
            };
            container.appendChild(addBtn);

            const table = document.createElement("table");
            container.appendChild(table);

            // Table header
            const thead = document.createElement("thead");
            const trHead = document.createElement("tr");

            schema.forEach(([col], colIndex) => {
                const th = document.createElement("th");
                th.textContent = col;
                th.onclick = () => { // Sorting on column click
                    if (sortState.columnIndex === colIndex) {
                        sortState.ascending = !sortState.ascending;
                    } else {
                        sortState.columnIndex = colIndex;
                        sortState.ascending = true;
                    }

                    // Sort data array
                    data.sort((a, b) => {
                        const valA = a[colIndex];
                        const valB = b[colIndex];

                        if (valA == null) return 1;
                        if (valB == null) return -1;

                        if (!isNaN(valA) && !isNaN(valB)) {
                            return sortState.ascending ? valA - valB : valB - valA;
                        }

                        return sortState.ascending
                            ? String(valA).localeCompare(String(valB), 'fa')
                            : String(valB).localeCompare(String(valA), 'fa');
                    });

                    renderTable(tableName); // Re-render table after sorting
                };

                if (sortState.columnIndex === colIndex) {
                    th.textContent += sortState.ascending ? " ▲" : " ▼"; // Show arrow
                }

                trHead.appendChild(th);
            });

            // Extra columns for Edit/Delete
            trHead.appendChild(document.createElement("th")).textContent = "Edit";
            trHead.appendChild(document.createElement("th")).textContent = "Delete";
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Table body
            const tbody = document.createElement("tbody");
            table.appendChild(tbody);

            // Add mode row
            if (editingRowIndex === -1) {
                const tr = document.createElement("tr");
                schema.forEach(([col]) => {
                    const td = document.createElement("td");
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = formData[col] || "";
                    input.oninput = (e) => {
                        formData[col] = e.target.value;
                    };
                    td.appendChild(input);
                    tr.appendChild(td);
                });

                // Save button
                const saveTd = document.createElement("td");
                const saveBtn = document.createElement("button");
                saveBtn.textContent = "Save";
                saveBtn.onclick = () => addRecord(tableName);
                saveTd.appendChild(saveBtn);
                tr.appendChild(saveTd);

                // Cancel button
                const cancelTd = document.createElement("td");
                const cancelBtn = document.createElement("button");
                cancelBtn.textContent = "Cancel";
                cancelBtn.onclick = () => {
                    editingRowIndex = null;
                    renderTable(tableName);
                };
                cancelTd.appendChild(cancelBtn);
                tr.appendChild(cancelTd);

                tbody.appendChild(tr);
            }

            // Render existing rows
            data.forEach((row, idx) => {
                const tr = document.createElement("tr");
                if (idx % 2 === 1) tr.style.backgroundColor = "#f0f0f0"; // Alternate row color

                if (editingRowIndex === idx) {
                    // Edit mode
                    schema.forEach(([col], i) => {
                        const td = document.createElement("td");
                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = formData[col] ?? row[i];
                        input.oninput = (e) => {
                            formData[col] = e.target.value;
                        };
                        td.appendChild(input);
                        tr.appendChild(td);
                    });

                    // Save button
                    const saveTd = document.createElement("td");
                    const saveBtn = document.createElement("button");
                    saveBtn.textContent = "Save";
                    saveBtn.onclick = () => saveEdit(tableName, idx);
                    saveTd.appendChild(saveBtn);
                    tr.appendChild(saveTd);

                    // Cancel button
                    const cancelTd = document.createElement("td");
                    const cancelBtn = document.createElement("button");
                    cancelBtn.textContent = "Cancel";
                    cancelBtn.onclick = () => {
                        editingRowIndex = null;
                        formData = {};
                        renderTable(tableName);
                    };
                    cancelTd.appendChild(cancelBtn);
                    tr.appendChild(cancelTd);
                } else {
                    // Normal row
                    row.forEach(val => {
                        const td = document.createElement("td");
                        td.textContent = val;
                        tr.appendChild(td);
                    });

                    // Edit button
                    const editTd = document.createElement("td");
                    const editBtn = document.createElement("button");
                    editBtn.textContent = "Edit";
                    editBtn.onclick = () => {
                        editingRowIndex = idx;
                        formData = {};
                        renderTable(tableName);
                    };
                    editTd.appendChild(editBtn);
                    tr.appendChild(editTd);

                    // Delete button
                    const deleteTd = document.createElement("td");
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Delete";
                    deleteBtn.onclick = () => deleteRecord(tableName, idx);
                    deleteTd.appendChild(deleteBtn);
                    tr.appendChild(deleteTd);
                }

                tbody.appendChild(tr);
            });
        }

        // Add new record via POST
        async function addRecord(tableName) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/tables/${tableName}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData),
                });
                if (!res.ok) throw new Error("Failed to add record");
                editingRowIndex = null;
                formData = {};
                data = await fetchJSON(`${API_BASE_URL}/api/tables/${tableName}`);
                renderTable(tableName);
            } catch (e) {
                alert(e.message);
            }
        }

        // Save edited record via PUT
        async function saveEdit(tableName, rowIndex) {
            try {
                const pkValue = data[rowIndex][0]; // Assume first column is PK
                const res = await fetch(`${API_BASE_URL}/api/tables/${tableName}/${pkValue}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData),
                });
                if (!res.ok) throw new Error("Failed to update record");
                editingRowIndex = null;
                formData = {};
                data = await fetchJSON(`${API_BASE_URL}/api/tables/${tableName}`);
                renderTable(tableName);
            } catch (e) {
                alert(e.message);
            }
        }

        // Delete a record via DELETE
        async function deleteRecord(tableName, rowIndex) {
            if (!confirm("Are you sure you want to delete this record?")) return;
            try {
                const pkValue = data[rowIndex][0]; // Assume first column is PK
                const res = await fetch(`${API_BASE_URL}/api/tables/${tableName}/${pkValue}`, {
                    method: "DELETE",
                });
                if (!res.ok) throw new Error("Failed to delete record");
                data = await fetchJSON(`${API_BASE_URL}/api/tables/${tableName}`);
                renderTable(tableName);
            } catch (e) {
                alert(e.message);
            }
        }

        // Initial load
        loadTables();
    </script>
</body>

</html>